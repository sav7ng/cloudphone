---
alwaysApply: true
---

# OpenClaw CloudPhone 开发规范文档（Plugin Agent Tools 方向）

## 目录

1. [概述](#概述)
2. [快速开始](#快速开始)
3. [插件结构](#插件结构)
4. [插件 Manifest](#插件-manifest)
5. [Agent 工具开发（核心）](#agent-工具开发核心)
6. [工具可用性与配置策略](#工具可用性与配置策略)
7. [其他插件 API](#其他插件-api)
8. [配置与验证](#配置与验证)
9. [CLI 命令](#cli-命令)
10. [命名规范](#命名规范)
11. [安全注意事项](#安全注意事项)
12. [测试与发布](#测试与发布)

---

## 概述

本项目以 **Plugin Agent Tools** 方向为核心，开发 OpenClaw 插件，为 LLM Agent 提供自定义的 JSON-Schema 工具函数。

OpenClaw 插件是扩展 Gateway 功能的 TypeScript 模块，通过 jiti 在运行时加载。插件可提供以下能力：

- **Agent 工具**（本项目核心方向）
- Gateway RPC 方法
- Gateway HTTP 处理器
- CLI 命令
- 后台服务
- Skills（技能）
- 自动回复命令

插件在 Gateway 进程中运行，视为**可信代码**。

> 官方文档：https://docs.openclaw.ai/plugins/agent-tools
> 插件概览：https://docs.openclaw.ai/tools/plugin

---

## 快速开始

### 查看已加载的插件

```bash
openclaw plugins list
```

### 安装插件

```bash
# 从 npm 安装（仅支持包名 + 可选版本/标签）
openclaw plugins install @openclaw/voice-call

# 从本地路径安装
openclaw plugins install ./extensions/my-plugin

# 链接模式（开发用，不复制）
openclaw plugins install -l ./extensions/my-plugin
```

### 配置插件

插件安装后需在 `plugins.entries.<id>.config` 中进行配置。配置更改**需要重启 Gateway**。

---

## 插件结构

### 目录布局

```
my-plugin/
├── openclaw.plugin.json    # 插件清单文件（必需）
├── package.json            # 可选，包含 npm 依赖
├── src/
│   ├── index.ts            # 入口文件
│   └── tools.ts            # Agent 工具定义
├── skills/                 # 可选技能目录
│   └── my-skill/
│       └── SKILL.md
└── README.md
```

### 插件发现与优先级

OpenClaw 按以下顺序扫描插件：

1. **配置路径** — `plugins.load.paths`（文件或目录）
2. **工作区扩展** — `<workspace>/.openclaw/extensions/*.ts` 或 `*/index.ts`
3. **全局扩展** — `~/.openclaw/extensions/*.ts` 或 `*/index.ts`
4. **捆绑扩展**（随 OpenClaw 分发，**默认禁用**）

如果多个插件解析为相同 ID，第一个匹配获胜。

### 插件入口导出方式

```typescript
// 方式1：函数形式
export default function (api) {
  // 注册插件功能
}

// 方式2：对象形式（推荐，可声明 configSchema）
export default {
  id: "my-plugin",
  name: "My Plugin",
  configSchema: { ... },
  register(api) {
    // 注册插件功能
  }
}
```

---

## 插件 Manifest

每个插件必须包含 `openclaw.plugin.json` 文件：

```json
{
  "id": "cloudphone",
  "name": "CPC Plugin",
  "version": "1.0.0",
  "description": "插件描述",
  "configSchema": {
    "type": "object",
    "additionalProperties": false,
    "properties": {
      "apiKey": { "type": "string" },
      "region": { "type": "string" }
    }
  },
  "uiHints": {
    "apiKey": { "label": "API Key", "sensitive": true },
    "region": { "label": "Region", "placeholder": "us-east-1" }
  }
}
```

### Manifest 字段说明

| 字段 | 类型 | 必需 | 说明 |
|------|------|------|------|
| `id` | string | 是 | 插件唯一标识符 |
| `name` | string | 是 | 插件显示名称 |
| `version` | string | 否 | 插件版本 |
| `description` | string | 否 | 插件描述 |
| `configSchema` | JSON Schema | 否 | 配置验证模式 |
| `uiHints` | object | 否 | UI 提示信息（标签、占位符、敏感标记） |
| `skills` | string[] | 否 | 技能目录列表 |
| `kind` | string | 否 | 插件类型（如 `"memory"`，用于独占槽位） |

---

## Agent 工具开发（核心）

本节是项目的**核心开发规范**，详细说明如何开发 Plugin Agent Tools。

Agent 工具是暴露给 LLM 的 JSON-Schema 函数，在 Agent 运行期间可被调用。工具分为两类：

- **必需工具（required）**：默认始终可用
- **可选工具（optional）**：需用户在配置中显式启用

### 基本工具（使用 TypeBox）

官方推荐使用 `@sinclair/typebox` 定义参数 schema，这是 OpenClaw 的 schema 标准：

```typescript
import { Type } from "@sinclair/typebox";

export default function (api) {
  api.registerTool({
    name: "my_tool",
    description: "Do a thing",
    parameters: Type.Object({
      input: Type.String(),
    }),
    async execute(_id, params) {
      return { content: [{ type: "text", text: params.input }] };
    },
  });
}
```

### 基本工具（使用原始 JSON Schema）

也可以使用原始 JSON Schema 对象定义参数：

```typescript
export default function (api) {
  api.registerTool({
    name: "my_tool",
    description: "Do a thing",
    parameters: {
      type: "object",
      properties: {
        input: { type: "string" },
      },
      required: ["input"],
    },
    async execute(_id, params) {
      return { content: [{ type: "text", text: params.input }] };
    },
  });
}
```

### 关键 API 说明

#### `api.registerTool(toolDef, options?)`

| 参数 | 说明 |
|------|------|
| `toolDef.name` | 工具名称，使用 `snake_case`，不可与核心工具名冲突 |
| `toolDef.description` | 向 LLM 说明工具用途的描述文本 |
| `toolDef.parameters` | TypeBox schema 或原始 JSON Schema 对象 |
| `toolDef.execute(_id, params)` | 执行函数，接收调用 ID 和参数，返回 MCP 风格结果 |
| `options.optional` | 设为 `true` 表示可选工具（opt-in） |

#### 返回值格式（MCP 风格）

工具的 `execute` 方法应返回 MCP Content 格式：

```typescript
return {
  content: [
    { type: "text", text: "返回的文本内容" }
  ]
};
```

### 可选工具（opt-in）

可选工具**不会自动启用**，用户必须将其添加到 Agent 的工具白名单中：

```typescript
export default function (api) {
  api.registerTool(
    {
      name: "workflow_tool",
      description: "Run a local workflow",
      parameters: {
        type: "object",
        properties: {
          pipeline: { type: "string" },
        },
        required: ["pipeline"],
      },
      async execute(_id, params) {
        return { content: [{ type: "text", text: params.pipeline }] };
      },
    },
    { optional: true },
  );
}
```

**何时使用 `optional: true`**：
- 工具会触发副作用（如发送消息、修改数据）
- 工具需要额外的二进制依赖或凭证
- 工具仅在特定场景下使用

### 工具开发规则与最佳实践

1. **工具名不可与核心工具名冲突**，冲突的工具会被跳过
2. **插件 ID 在白名单中不可与核心工具名冲突**
3. **有副作用的工具优先设为 `optional: true`**
4. 工具名使用 `snake_case` 格式
5. 描述文本应清晰说明工具的功能和所需参数
6. `execute` 方法应做好错误处理，返回有意义的错误信息

---

## 工具可用性与配置策略

Agent 工具的可用性通过多层配置控制：

### 在 Agent 白名单中启用可选工具

```json5
{
  agents: {
    list: [
      {
        id: "main",
        tools: {
          allow: [
            "workflow_tool",   // 启用特定工具名
            "workflow",        // 启用插件的所有工具（按插件 ID）
            "group:plugins",   // 启用所有插件工具
          ],
        },
      },
    ],
  },
}
```

### 其他影响工具可用性的配置

| 配置项 | 说明 |
|--------|------|
| `tools.allow` / `agents.list[].tools.allow` | 全局或 Agent 级别工具白名单 |
| `tools.profile` / `agents.list[].tools.profile` | 基础白名单 profile |
| `tools.byProvider` / `agents.list[].tools.byProvider` | 按 Provider 的 allow/deny |
| `tools.sandbox.tools.*` | 沙箱模式下的工具策略 |

**注意**：仅列出插件工具名的白名单被视为插件 opt-in；核心工具仍然可用，除非你同时在白名单中包含核心工具或分组。

---

## 其他插件 API

除核心的 Agent 工具外，插件还可注册以下功能：

### 注册 Gateway RPC 方法

```typescript
export default function (api) {
  api.registerGatewayMethod("myplugin.status", ({ respond }) => {
    respond(true, { ok: true });
  });
}
```

### 注册 Gateway HTTP 处理器

```typescript
export default function (api) {
  api.registerHttpHandler({
    method: "GET",
    path: "/my-plugin/status",
    handler: async (req, res) => {
      res.json({ status: "ok" });
    }
  });
}
```

### 注册 CLI 命令

```typescript
export default function (api) {
  api.registerCli(
    ({ program }) => {
      program.command("mycmd").action(() => {
        console.log("Hello");
      });
    },
    { commands: ["mycmd"] },
  );
}
```

### 注册自动回复命令

无需调用 AI Agent 即可执行的斜杠命令：

```typescript
export default function (api) {
  api.registerCommand({
    name: "mystatus",
    description: "Show plugin status",
    handler: (ctx) => ({
      text: `Plugin is running! Channel: ${ctx.channel}`,
    }),
  });
}
```

**命令处理器上下文（ctx）**：`senderId`、`channel`、`isAuthorizedSender`、`args`、`commandBody`、`config`

**命令选项**：`name`、`description`、`acceptsArgs`（默认 false）、`requireAuth`（默认 true）、`handler`

### 注册后台服务

```typescript
export default function (api) {
  api.registerService({
    id: "my-service",
    start: () => api.logger.info("ready"),
    stop: () => api.logger.info("bye"),
  });
}
```

### 注册插件钩子

```typescript
export default function (api) {
  api.registerHook(
    "command:new",
    async () => {
      // 钩子逻辑
    },
    {
      name: "my-plugin.command-new",
      description: "Runs when /new is invoked",
    },
  );
}
```

### 运行时帮助器

```typescript
const result = await api.runtime.tts.textToSpeechTelephony({
  text: "Hello from OpenClaw",
  cfg: api.config,
});
```

---

## 配置与验证

### 插件配置

```json5
{
  plugins: {
    enabled: true,
    allow: ["cloudphone"],
    deny: ["untrusted-plugin"],
    load: { paths: ["~/Projects/oss/my-extension"] },
    entries: {
      "cloudphone": {
        enabled: true,
        config: { baseUrl: "https://cptest.yaltc.cn", token: "..." }
      },
    },
  },
}
```

### 配置验证规则

- 未知插件 ID 在 `entries`、`allow`、`deny`、`slots` 中是**错误**
- 插件配置使用 `openclaw.plugin.json` 中的 JSON Schema 验证
- 如果插件被禁用，其配置会被保留并发出**警告**

### Control UI（配置界面）

在 manifest 中提供 `uiHints` 和 `configSchema`，Control UI 会自动渲染表单。敏感字段（如 Token）应标记 `"sensitive": true`。

---

## CLI 命令

| 命令 | 说明 |
|------|------|
| `openclaw plugins list` | 列出所有插件 |
| `openclaw plugins info <id>` | 显示插件信息 |
| `openclaw plugins install <path>` | 安装插件 |
| `openclaw plugins install -l <path>` | 链接模式安装（开发用） |
| `openclaw plugins update <id>` | 更新插件 |
| `openclaw plugins update --all` | 更新所有插件 |
| `openclaw plugins enable <id>` | 启用插件 |
| `openclaw plugins disable <id>` | 禁用插件 |
| `openclaw plugins doctor` | 诊断插件问题 |

---

## 命名规范

| 类型 | 命名规则 | 示例 |
|------|----------|------|
| 插件 ID | kebab-case | `cloudphone`、`voice-call` |
| Agent 工具 | snake_case | `cpc_echo`、`cpc_get_device_connection_link` |
| Gateway 方法 | `pluginId.action` | `cloudphone.status` |
| CLI 命令 | kebab 或 camel | `mycmd`、`my-cmd` |

**注意**：
- 工具名**不可与核心工具名冲突**，冲突的工具会被跳过
- 插件 ID 在白名单中**不可与核心工具名冲突**
- 保留命令名（如 `help`、`status`、`reset` 等）**不能**被插件覆盖
- 包 packs 的默认插件 ID 取自 `package.json` 的 `name`

---

## 安全注意事项

1. **插件视为可信代码**：插件在 Gateway 进程中运行
2. **使用 allowlist**：建议使用 `plugins.allow` 白名单
3. **修改后重启**：更改插件后需要重启 Gateway
4. **禁止生命周期脚本**：安装依赖时使用 `npm install --ignore-scripts`
5. **路径安全检查**：OpenClaw 会阻止路径遍历、符号链接逃逸、世界可写目录
6. **扩展入口限制**：`openclaw.extensions` 中的入口必须在插件目录内，逃逸的路径会被拒绝

---

## 测试与发布

### 本地测试

1. 将插件放入扩展目录：
   - `<workspace>/.openclaw/extensions/*/index.ts`
   - `~/.openclaw/extensions/`
2. 或使用 `plugins.load.paths` 配置加载路径
3. 或使用链接模式：`openclaw plugins install -l ./my-plugin`
4. 重启 Gateway

### 发布到 npm

```json
{
  "name": "@openclaw/my-plugin",
  "openclaw": {
    "extensions": ["./dist/index.js"]
  }
}
```

入口文件可以是 `.js` 或 `.ts`（jiti 在运行时加载 TS）。

### 插件测试

- 仓库内插件可在 `src/**` 下使用 Vitest 编写测试
- 独立发布的插件应自行运行 CI（lint/build/test），确保 `openclaw.extensions` 指向构建产物

---

## 开发工作流

1. **创建插件目录结构**
2. **编写 `openclaw.plugin.json` manifest**（定义 id、configSchema、uiHints）
3. **定义 Agent 工具**（使用 `api.registerTool` + `execute` 方法 + MCP 返回格式）
4. **本地测试**（链接模式或扩展目录 + 重启 Gateway）
5. **配置插件**（`plugins.entries.<id>.config`）
6. **验证工具调用**（确认 Agent 可发现并正确调用工具）
7. **打包发布**（如需发布到 npm）

---

## 参考资料

- Agent 工具开发：https://docs.openclaw.ai/plugins/agent-tools
- 插件概览：https://docs.openclaw.ai/tools/plugin
- TypeBox 规范：https://docs.openclaw.ai/concepts/typebox
- 社区插件：https://docs.openclaw.ai/plugins/community
